trigger: none
pr: none

pool:
  name: Default  # ← ご自身の Self-hosted Agent 名に合わせて

variables:
  - name: System.Debug
    value: 'true'

stages:
# ① PFX証明書生成
- stage: Stage1_PFX
  displayName: '① PFX証明書生成'
  jobs:
  - job: GeneratePFX
    displayName: 'OpenSSLで taro.pfx 作成'
    steps:
    - task: PowerShell@2
      displayName: 'Generate .pfx from vars.json'
      inputs:
        targetType: filePath
        filePath: stage1-pfx/generate_cert.ps1

    - task: PublishBuildArtifacts@1
      displayName: '📤 Publish PFX certs'
      inputs:
        PathtoPublish: '$(Build.ArtifactStagingDirectory)/certs'
        ArtifactName: 'certs'
        publishLocation: 'Container'

# ② Azure VPN設定ファイル取得
- stage: Stage2_AzureVPN
  displayName: '② Azure VPN設定ファイル取得'
  dependsOn: Stage1_PFX
  jobs:
  - job: GetAzureVPN
    displayName: 'VPN Gateway から azurevpnconfig.xml を含む ZIP を取得'
    steps:
    - task: AzureCLI@2
      displayName: 'Get VPN profile ZIP via Azure CLI'
      inputs:
        azureSubscription: 'AzureRM-vpn-connection'  # ✅ Service Connection 名
        scriptType: ps
        scriptLocation: scriptPath
        scriptPath: stage2-azurevpn/get_profile.ps1

    - task: PublishBuildArtifacts@1
      displayName: '📤 Publish VPN profile.zip'
      inputs:
        PathtoPublish: '$(Build.ArtifactStagingDirectory)/vpn'
        ArtifactName: 'vpn'
        publishLocation: 'Container'

# ③ ZIP化 & Slack通知（Webhook削除＋Slack Botトークン対応版）
- stage: Stage3_ZipAndNotify
  displayName: '③ ZIP化 & Slack通知'
  dependsOn: Stage2_AzureVPN
  jobs:
  - job: NotifySlack
    displayName: 'pfx + azurevpnconfig.xml を ZIP にまとめて通知'
    steps:
    - task: DownloadBuildArtifacts@0
      displayName: '📥 Download PFX artifact'
      inputs:
        artifactName: 'certs'
        downloadPath: '$(Build.ArtifactStagingDirectory)/certs'

    - task: DownloadBuildArtifacts@0
      displayName: '📥 Download VPN artifact'
      inputs:
        artifactName: 'vpn'
        downloadPath: '$(Build.ArtifactStagingDirectory)/vpn'

    - task: PowerShell@2
      displayName: 'Package (Slack通知テスト付き)'
      inputs:
        targetType: filePath
        filePath: stage3-package/package_and_notify.ps1
      env:
        SLACK_BOT_TOKEN: $(SLACK_BOT_TOKEN)  # ✅ 追加：Slack API トークンを環境変数で渡す
