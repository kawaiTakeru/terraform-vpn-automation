trigger: none
pr: none

pool:
  name: Default  # â† ã”è‡ªèº«ã® Self-hosted Agent åã«åˆã‚ã›ã¦

variables:
  - name: System.Debug
    value: 'true'

stages:
# â‘  PFXè¨¼æ˜æ›¸ç”Ÿæˆ
- stage: Stage1_PFX
  displayName: 'â‘  PFXè¨¼æ˜æ›¸ç”Ÿæˆ'
  jobs:
  - job: GeneratePFX
    displayName: 'OpenSSLã§ taro.pfx ä½œæˆ'
    steps:
    - task: PowerShell@2
      displayName: 'Generate .pfx from vars.json'
      inputs:
        targetType: filePath
        filePath: stage1-pfx/generate_cert.ps1

    - task: PublishBuildArtifacts@1
      displayName: 'ğŸ“¤ Publish PFX certs'
      inputs:
        PathtoPublish: '$(Build.ArtifactStagingDirectory)/certs'
        ArtifactName: 'certs'
        publishLocation: 'Container'

# â‘¡ Azure VPNè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«å–å¾—
- stage: Stage2_AzureVPN
  displayName: 'â‘¡ Azure VPNè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«å–å¾—'
  dependsOn: Stage1_PFX
  jobs:
  - job: GetAzureVPN
    displayName: 'VPN Gateway ã‹ã‚‰ azurevpnconfig.xml ã‚’å«ã‚€ ZIP ã‚’å–å¾—'
    steps:
    - task: AzureCLI@2
      displayName: 'Get VPN profile ZIP via Azure CLI'
      inputs:
        azureSubscription: 'AzureRM-vpn-connection'  # âœ… Service Connection å
        scriptType: ps
        scriptLocation: scriptPath
        scriptPath: stage2-azurevpn/get_profile.ps1

    - task: PublishBuildArtifacts@1
      displayName: 'ğŸ“¤ Publish VPN profile.zip'
      inputs:
        PathtoPublish: '$(Build.ArtifactStagingDirectory)/vpn'
        ArtifactName: 'vpn'
        publishLocation: 'Container'

# â‘¢ ZIPåŒ– & Slacké€šçŸ¥ï¼ˆWebhookå‰Šé™¤ï¼‹Slack Botãƒˆãƒ¼ã‚¯ãƒ³å¯¾å¿œç‰ˆï¼‰
- stage: Stage3_ZipAndNotify
  displayName: 'â‘¢ ZIPåŒ– & Slacké€šçŸ¥'
  dependsOn: Stage2_AzureVPN
  jobs:
  - job: NotifySlack
    displayName: 'pfx + azurevpnconfig.xml ã‚’ ZIP ã«ã¾ã¨ã‚ã¦é€šçŸ¥'
    steps:
    - task: DownloadBuildArtifacts@0
      displayName: 'ğŸ“¥ Download PFX artifact'
      inputs:
        artifactName: 'certs'
        downloadPath: '$(Build.ArtifactStagingDirectory)/certs'

    - task: DownloadBuildArtifacts@0
      displayName: 'ğŸ“¥ Download VPN artifact'
      inputs:
        artifactName: 'vpn'
        downloadPath: '$(Build.ArtifactStagingDirectory)/vpn'

    - task: PowerShell@2
      displayName: 'Package (Slacké€šçŸ¥ãƒ†ã‚¹ãƒˆä»˜ã)'
      inputs:
        targetType: filePath
        filePath: stage3-package/package_and_notify.ps1
      env:
        SLACK_BOT_TOKEN: $(SLACK_BOT_TOKEN)  # âœ… è¿½åŠ ï¼šSlack API ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç’°å¢ƒå¤‰æ•°ã§æ¸¡ã™
