trigger: none
pr: none

pool:
  name: Default  # â† ã”è‡ªèº«ã® Self-hosted Agent åã«åˆã‚ã›ã¦

variables:
  - name: System.Debug
    value: 'true'
  # ğŸ”» å‰Šé™¤ï¼šå¾ªç’°å‚ç…§ã‚’é¿ã‘ã‚‹ãŸã‚
  # - name: SLACK_WEBHOOK_URL
  #   value: $(SLACK_WEBHOOK_URL)

stages:
- stage: Stage1_PFX
  displayName: 'â‘  PFXè¨¼æ˜æ›¸ç”Ÿæˆ'
  jobs:
  - job: GeneratePFX
    displayName: 'OpenSSLã§.taro.pfxä½œæˆ'
    steps:
    - task: PowerShell@2
      displayName: 'Generate .pfx from vars.json'
      inputs:
        targetType: filePath
        filePath: stage1-pfx/generate_cert.ps1

- stage: Stage2_AzureVPN
  displayName: 'â‘¡ Azure VPNè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«å–å¾—'
  dependsOn: Stage1_PFX
  jobs:
  - job: GetAzureVPN
    displayName: 'VPN Gatewayã‹ã‚‰ .azurevpn ZIPã‚’å–å¾—'
    steps:
    - task: AzureCLI@2
      displayName: 'Get VPN profile ZIP via Azure CLI'
      inputs:
        azureSubscription: 'AzureRM-vpn-connection'  # âœ… å…ˆã»ã©ä½œæˆã—ãŸService Connectionå
        scriptType: ps
        scriptLocation: scriptPath
        scriptPath: stage2-azurevpn/get_profile.ps1

- stage: Stage3_ZipAndNotify
  displayName: 'â‘¢ ZIPåŒ– & Slacké€šçŸ¥'
  dependsOn: Stage2_AzureVPN
  jobs:
  - job: NotifySlack
    displayName: 'pfx + .azurevpn ã‚’ ZIP ã«ã¾ã¨ã‚ã¦é€šçŸ¥'
    steps:
    - task: PowerShell@2
      displayName: 'Package and Notify'
      inputs:
        targetType: filePath
        filePath: stage3-package/package_and_notify.ps1
