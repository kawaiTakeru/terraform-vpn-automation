trigger: none
pr: none

pool:
  name: Default  # ← ご自身の Self-hosted Agent 名に合わせて

variables:
  - name: System.Debug
    value: 'true'
  # 🔻 削除：循環参照を避けるため
  # - name: SLACK_WEBHOOK_URL
  #   value: $(SLACK_WEBHOOK_URL)

stages:
- stage: Stage1_PFX
  displayName: '① PFX証明書生成'
  jobs:
  - job: GeneratePFX
    displayName: 'OpenSSLで.taro.pfx作成'
    steps:
    - task: PowerShell@2
      displayName: 'Generate .pfx from vars.json'
      inputs:
        targetType: filePath
        filePath: stage1-pfx/generate_cert.ps1

- stage: Stage2_AzureVPN
  displayName: '② Azure VPN設定ファイル取得'
  dependsOn: Stage1_PFX
  jobs:
  - job: GetAzureVPN
    displayName: 'VPN Gatewayから .azurevpn ZIPを取得'
    steps:
    - task: AzureCLI@2
      displayName: 'Get VPN profile ZIP via Azure CLI'
      inputs:
        azureSubscription: 'AzureRM-vpn-connection'  # ✅ 先ほど作成したService Connection名
        scriptType: ps
        scriptLocation: scriptPath
        scriptPath: stage2-azurevpn/get_profile.ps1

- stage: Stage3_ZipAndNotify
  displayName: '③ ZIP化 & Slack通知'
  dependsOn: Stage2_AzureVPN
  jobs:
  - job: NotifySlack
    displayName: 'pfx + .azurevpn を ZIP にまとめて通知'
    steps:
    - task: PowerShell@2
      displayName: 'Package and Notify'
      inputs:
        targetType: filePath
        filePath: stage3-package/package_and_notify.ps1
